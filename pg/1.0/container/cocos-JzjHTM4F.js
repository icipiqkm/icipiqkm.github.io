import{v as C}from"./index-Cmyw4h-l.js";import{useLaunchStore as G}from"./launch-BoVfp9fK.js";const I=G(),F=C("cocosStore",()=>{function z(o,a){var e=o.indexOf("?");e>0&&(o=o.substring(0,e));var r=/(\/|\\)([^\/\\]+)$/g,n=r.exec(o.replace(/(\/|\\)$/,""));if(!n)return o;var i=n[2];return i}var u={},f={},d=new Map;async function L(){await A(),console.log(u),console.log(f)}async function R(o){const a=["internal","resources","main","app","http"],e=[...u.engine.list];var r=u.engine.size;a.forEach(n=>{const i=u.modules[n];i&&(r+=i.size,e.push(...i.list),delete u.modules[n]);var l=null;for(const w in f)if(w.includes(n)){l=f[w],delete f[w];break}l&&(r+=l.size,e.push(...l.list))}),await x(e,r,o),await k()}async function $(o){const a=[];var e=0;for(const r in u.modules){const n=u.modules[r];e+=n.size,a.push(...n.list)}for(const r in f){const n=f[r];e+=n.size,a.push(...n.list)}console.log("加载游戏资源",a,e),await x(a,e,o)}function S(o){window.removeEventListener("on:engine-ready",S);const a=/^(?:\w+:\/\/|\.+\/).+/;function e(t){return d.has(t)?d.get(t):(console.warn("漏网之鱼",t),t)}const r=cc.assetManager.downloader._downloaders[".png"];function n(t,s,c){return r(e(t),s,c)}const i=cc.assetManager.downloader._downloaders[".json"];function l(t,s,c){return i(e(t),s,c)}const w=cc.assetManager.downloader._downloaders[".mp3"];function b(t,s,c){return console.log("下载音频",t,s,c),w(e(t),s,c)}const h={".png":n,".jpg":n,".bmp":n,".jpeg":n,".gif":n,".ico":n,".tiff":n,".webp":n,".image":n,".json":l,".mp3":b};for(const t in h){const s=h[t];cc.assetManager.downloader._downloaders[t]=s}const v=cc.assetManager.downloader.downloadScript;cc.assetManager.downloader.downloadScript=function(t,s,c){return v.call(this,e(t),s,c)},cc.assetManager.downloader._downloaders.bundle=function(t,s,c){var _=z(t),g=t;a.test(g)||(cc.assetManager.downloader.remoteBundles.indexOf(_)!==-1?g=cc.assetManager.downloader.remoteServerAddress+"remote/"+_:g="assets/"+_);var y=s.version||cc.assetManager.downloader.bundleVers[_],E=0,N=g+"/config."+(y?y+".":"")+"json",m=null,p=null;cc.assetManager.downloader._downloaders[".json"](N,s,function(M,B){p=M||p,m=B,m&&(m.base=g+"/"),++E===2&&c(p,m)});var P=g+"/index."+(y?y+".":"")+"js";cc.assetManager.downloader.downloadScript(P,s,function(M){p=M||p,++E===2&&c(p,m)})}}async function k(){const o=u.engine;window.addEventListener("on:engine-ready",S),J(o.importMap,"systemjs-importmap"),await import(d.get(o.polyfills)),await import(d.get(o.systemJs));const a=System.instantiate;System.instantiate=function(e,r){const n=e.replace(new RegExp(`blob:|${window.location.origin}/`,"g"),"");return d.has(n)&&(e=d.get(n)),a.call(this,e,r)},await System.import(d.get(o.indexJs),window.location.origin)}async function J(o,a){let e=document.createElement("script");e.type=a,e.async=!0,e.src=o,document.head.appendChild(e)}async function A(){const o="/paths/path_map.json",a=`/paths/${I.getLanguage()}.json`;await Promise.all([j(o).then(e=>{u=e}),j(a).then(e=>{f=e})])}async function j(o){return new Promise(a=>{fetch(o).then(e=>e.json()).then(e=>{a(e)})})}async function x(o,a,e){let r=0;d||(d=new Map),await Promise.all(o.map(async n=>{var v;let i;try{i=await fetch(n)}catch(t){console.error(`Failed to fetch script from ${n}: ${t}`);return}const l=(v=i==null?void 0:i.body)==null?void 0:v.getReader();let w=[];for(;;){const{done:t,value:s}=await(l==null?void 0:l.read());if(t)break;w.push(s),r+=s.length;let c=r/a*100;e(c)}const b=i.headers.get("Content-Type"),h=new Blob(w,{type:b});d.set(n,URL.createObjectURL(h))}))}return{init:L,initEngine:R,initGame:$}});export{F as useCocosStore};
